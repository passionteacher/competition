<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>음성 스크롤</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter 폰트 임포트 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        html, body {
            height: 100vh;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .app-container {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            background-color: #ffffff;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .header {
            background-color: #ffffff;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #f0f0f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .video-feed {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
            padding-bottom: 6rem;
            min-height: 300px;
        }
        .video-feed::-webkit-scrollbar {
            display: none;
        }
        .video-feed {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .video-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: transform 0.2s ease-in-out;
        }
        .video-card:hover {
            transform: translateY(-3px);
        }
        .video-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .video-card .p-4 {
            padding: 1rem;
        }
        .video-card h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 0.25rem;
        }
        .video-card p {
            font-size: 0.875rem;
            color: #6b7280;
        }

        /* 음성 인식 상태 바 스타일 */
        .speech-status-bar {
            background-color: #4a5568;
            color: #ffffff;
            padding: 1rem 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(0);
            min-height: 4rem; /* 충분한 높이 확보 */
        }

        /* 마이크 아이콘 깜빡임 애니메이션 */
        @keyframes pulse-mic {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        .mic-pulsing {
            animation: pulse-mic 1.5s infinite ease-in-out;
        }
        
        /* 명령 대기 중 상태 바 색상 */
        .speech-status-bar.listening-for-command {
            background-color: #10B981;
            transform: translateY(-5px);
        }
        /* 명령 인식 완료/실행 상태 바 색상 */
        .speech-status-bar.command-executed {
            background-color: #2563eb;
        }
        /* 오류 상태 바 색상 */
        .speech-status-bar.error-state {
            background-color: #dc2626;
        }
        /* 실시간 인식 텍스트 스타일 */
        #interimText {
            display: block;
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.25rem;
            font-weight: 400;
        }
        
        /* 오류 팝업 스타일 */
        .error-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .error-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .error-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 320px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .error-modal.show .error-content {
            transform: scale(1);
        }
        .error-content h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #dc2626;
            margin-bottom: 0.5rem;
        }
        .error-content p {
            font-size: 1rem;
            color: #4b5563;
            margin-bottom: 1.5rem;
        }
        .error-content ul {
            text-align: left;
            margin-bottom: 1.5rem;
            list-style: decimal;
            padding-left: 1.5rem;
            font-size: 0.9rem;
            color: #4b5563;
        }
        .error-content button {
            background-color: #dc2626;
            color: #fff;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            transition: background-color 0.2s ease;
        }
        .error-content button:hover {
            background-color: #b91c1c;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="app-container">
        <!-- 상단 헤더 바 -->
        <header class="header">
            <div class="flex items-center">
                <img src="https://placehold.co/32x32/FF0000/FFFFFF?text=YT" alt="YouTube Logo" class="mr-2 rounded-md">
                <h1 class="text-xl font-bold text-gray-800">YouTube</h1>
            </div>
            <div class="flex items-center space-x-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" />
                </svg>
                <img alt="Profile Picture" class="rounded-full w-8 h-8 object-cover" src="https://placehold.co/32x32/007BFF/FFFFFF?text=P">
            </div>
        </header>

        <!-- 비디오 피드 (스크롤 가능한 영역) -->
        <main class="video-feed">
            <!-- 비디오 카드 예시 (반복) -->
            <div class="video-card">
                <img alt="Video Thumbnail" src="https://placehold.co/600x337/E0E0E0/333333?text=Video+Thumbnail+1">
                <div class="p-4">
                    <h2>놀라운 자연 다큐멘터리: 숨겨진 세계의 발견</h2>
                    <p>내셔널 지오그래픽 • 조회수 120만회 • 2일 전</p>
                </div>
            </div>

            <div class="video-card">
                <img alt="Video Thumbnail" src="https://placehold.co/600x337/D0D0D0/333333?text=Video+Thumbnail+2">
                <div class="p-4">
                    <h2>최신 기술 트렌드 2024: 미래를 바꾸는 혁신</h2>
                    <p>테크 인사이트 • 조회수 85만회 • 1주 전</p>
                </div>
            </div>

            <div class="video-card">
                <img alt="Video Thumbnail" src="https://placehold.co/600x337/C0C0C0/333333?text=Video+Thumbnail+3">
                <div class="p-4">
                    <h2>초보자를 위한 요리 강좌: 10분 만에 만드는 파스타</h2>
                    <p>맛있는 레시피 • 조회수 50만회 • 3일 전</p>
                </div>
            </div>

            <div class="video-card">
                <img alt="Video Thumbnail" src="https://placehold.co/600x337/B0B0B0/333333?text=Video+Thumbnail+4">
                <div class="p-4">
                    <h2>세계 여행 브이로그: 유럽의 숨겨진 보석들</h2>
                    <p>여행자 김씨 • 조회수 200만회 • 2주 전</p>
                </div>
            </div>

            <div class="video-card">
                <img alt="Video Thumbnail" src="https://placehold.co/600x337/A0A0A0/333333?text=Video+Thumbnail+5">
                <div class="p-4">
                    <h2>집에서 할 수 있는 간단한 운동 루틴</h2>
                    <p>건강한 라이프 • 조회수 70만회 • 4일 전</p>
                </div>
            </div>

            <div class="video-card">
                <img alt="Video Thumbnail" src="https://placehold.co/600x337/909090/333333?text=Video+Thumbnail+6">
                <div class="p-4">
                    <h2>클래식 음악 명곡 모음: 집중력을 높이는 선율</h2>
                    <p>뮤직 힐링 • 조회수 150만회 • 1달 전</p>
                </div>
            </div>
            <!-- 추가 비디오 카드 시작 -->
            <div class="video-card">
                <img alt="Video Thumbnail" src="https://placehold.co/600x337/808080/333333?text=Video+Thumbnail+7">
                <div class="p-4">
                    <h2>환상적인 우주 탐험: 미지의 행성들</h2>
                    <p>우주 다큐 • 조회수 220만회 • 3일 전</p>
                </div>
            </div>
            <div class="video-card">
                <img alt="Video Thumbnail" src="https://placehold.co/600x337/707070/333333?text=Video+Thumbnail+8">
                <div class="p-4">
                    <h2>역사 속 위대한 순간들: 인류의 발자취</h2>
                    <p>역사 채널 • 조회수 180만회 • 1주 전</p>
                </div>
            </div>
            <div class="video-card">
                <img alt="Video Thumbnail" src="https://placehold.co/600x337/606060/333333?text=Video+Thumbnail+9">
                <div class="p-4">
                    <h2>최고의 게임 플레이: 전설적인 순간들</h2>
                    <p>게임 채널 • 조회수 300만회 • 5일 전</p>
                </div>
            </div>
            <div class="video-card">
                <img alt="Video Thumbnail" src="https://placehold.co/600x337/505050/333333?text=Video+Thumbnail+10">
                <div class="p-4">
                    <h2>인공지능의 미래: 우리의 삶을 어떻게 바꿀까?</h2>
                    <p>미래 기술 • 조회수 90만회 • 2일 전</p>
                </div>
            </div>
            <!-- 추가 비디오 카드 끝 -->
        </main>

        <!-- 음성 인식 시작 버튼과 상태 메시지 바를 포함하는 하단 영역 -->
        <div class="speech-status-bar">
            <!-- 상태 메시지를 보여주는 컨테이너 -->
            <div id="statusContainer" class="flex flex-col items-center">
                 <!-- 마이크 아이콘 -->
                <svg id="micIcon" class="h-6 w-6 mb-1 text-white opacity-60 transition-opacity duration-300" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 1a3 3 0 00-3 3v6a3 3 0 006 0V4a3 3 0 00-3-3zM3 10a9 9 0 0018 0h-2a7 7 0 01-14 0H3zm9 13c-2.76 0-5-2.24-5-5h2c0 1.65 1.35 3 3 3s3-1.35 3-3h2c0 2.76-2.24 5-5 5z"/>
                </svg>
                <span id="speechStatus" class="font-medium text-sm text-center">마이크 권한을 확인 중입니다...</span>
                <span id="interimText" class="hidden text-xs text-center italic text-white opacity-70"></span>
            </div>
        </div>
    </div>

    <!-- 오류 팝업 UI -->
    <div id="errorModal" class="error-modal">
        <div class="error-content">
            <h3>마이크 권한 오류</h3>
            <p id="errorModalText"></p>
            <button id="closeErrorModal">확인</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const videoFeed = document.querySelector('.video-feed');
            const speechStatus = document.getElementById('speechStatus');
            const interimText = document.getElementById('interimText');
            const micIcon = document.getElementById('micIcon');
            const speechStatusBar = document.querySelector('.speech-status-bar');
            const errorModal = document.getElementById('errorModal');
            const errorModalText = document.getElementById('errorModalText');
            const closeErrorModalButton = document.getElementById('closeErrorModal');

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            let audioContext = null;

            let recognition = null;
            let wakeWordDetected = false;
            let commandTimeout = null;

            const WAKE_WORD = '하이 빅스비';
            const SCROLL_UP_COMMANDS = [
                '위로 올려줘', '위로 올려', '올려줘', '올려', '스크롤 위로', '스크롤 올려', '스크롤업',
                '위로 올려 주세요', '위로 올려주세요', '반만 올려줘', '반만 올려', '절반만 올려줘',
                '스끄롤 업', '쓰끄롤 업'
            ];
            const SCROLL_DOWN_COMMANDS = [
                '아래로 내려줘', '아래로 내려', '내려줘', '내려', '스크롤 아래로', '스크롤 내려', '스크롤다운',
                '아래로 내려 주세요', '아래로 내려주세요', '반만 내려줘', '반만 내려', '절반만 내려줘',
                '스끄롤 다운', '스끄롤 따운', '쓰끄롤 따운'
            ];
            const COMMAND_TIMEOUT_MS = 5000;
            let isRecognitionActive = false;

            // 오류 팝업 표시 함수
            function showErrorModal(message) {
                errorModalText.textContent = message;
                const existingUl = errorModal.querySelector('ul');
                if (existingUl) {
                    existingUl.remove();
                }
                errorModal.classList.add('show');
            }
            
            // 오류 팝업에 리스트를 포함하여 표시하는 함수
            function showErrorModalWithList(message, listItems) {
                errorModalText.textContent = message;
                const ul = document.createElement('ul');
                ul.className = 'mt-4 text-left';
                listItems.forEach(itemText => {
                    const li = document.createElement('li');
                    li.textContent = itemText;
                    ul.appendChild(li);
                });
                const existingUl = errorModal.querySelector('ul');
                if (existingUl) {
                    existingUl.remove();
                }
                errorModal.querySelector('.error-content').insertBefore(ul, closeErrorModalButton);
                errorModal.classList.add('show');
            }

            // 오류 팝업 숨기기 함수
            function hideErrorModal() {
                errorModal.classList.remove('show');
                // 오류 팝업을 닫으면 페이지를 새로고침하여 초기화 시도
                window.location.reload();
            }
            
            // '삐' 소리 재생 함수
            function playSound() {
                if (!AudioContext) {
                    console.warn("[DEBUG] Web Audio API를 지원하지 않습니다. 삐 소리 재생 불가.");
                    return;
                }
                if (!audioContext) {
                    audioContext = new AudioContext();
                    console.log("[DEBUG] AudioContext initialized.");
                }

                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => _createAndPlayOscillator()).catch(e => console.error("[DEBUG] AudioContext resume failed:", e));
                } else {
                    _createAndPlayOscillator();
                }

                function _createAndPlayOscillator() {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.start(audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
                    oscillator.stop(audioContext.currentTime + 0.1);
                    console.log("[DEBUG] Sound played successfully.");
                }
            }

            // 웨이크 워드 상태 초기화
            function resetWakeWordState() {
                wakeWordDetected = false;
                clearTimeout(commandTimeout);
                speechStatus.textContent = `음성 명령을 기다리는 중입니다. "${WAKE_WORD}"라고 또렷하게 말해주세요.`;
                interimText.textContent = '';
                interimText.classList.add('hidden');
                micIcon.classList.remove('mic-pulsing');
                micIcon.style.opacity = '0.6';
                speechStatusBar.classList.remove('listening-for-command', 'command-executed', 'error-state');
                console.log("[DEBUG] 상태 리셋: 웨이크 워드 대기 중.");
            }

            // 음성 인식 시작 함수
            function startSpeechRecognition() {
                if (!SpeechRecognition) {
                    speechStatus.textContent = '죄송합니다. 이 브라우저는 음성 인식을 지원하지 않습니다.';
                    console.warn('Web Speech API (SpeechRecognition) is not supported in this browser.');
                    showErrorModal('죄송합니다. 이 브라우저는 음성 인식을 지원하지 않습니다.');
                    return;
                }
                
                // 이미 활성화 상태라면 재시작하지 않음
                if (isRecognitionActive) {
                    console.log("[DEBUG] 이미 음성 인식이 활성화되어 있습니다. 재시작하지 않습니다.");
                    return;
                }
                
                isRecognitionActive = true;
                
                recognition = new SpeechRecognition();
                recognition.continuous = true; 
                recognition.interimResults = true; 
                recognition.lang = 'ko-KR'; 
                recognition.maxAlternatives = 10;

                // 이벤트 핸들러 설정
                recognition.onstart = () => {
                    micIcon.classList.add('mic-pulsing');
                    micIcon.style.opacity = '1';
                    console.log("[DEBUG] 음성 인식 시작됨.");
                    speechStatus.textContent = `마이크가 준비되었습니다. "${WAKE_WORD}"라고 말해주세요.`;
                    interimText.classList.remove('hidden');
                    interimText.textContent = '';
                    speechStatusBar.classList.remove('listening-for-command', 'command-executed', 'error-state');
                    wakeWordDetected = false;
                };

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        const result = event.results[i];
                        if (result.isFinal) {
                            finalTranscript += result[0].transcript;
                        } else {
                            interimTranscript += result[0].transcript;
                        }
                    }

                    // 임시 음성 인식 결과를 실시간으로 표시
                    if (interimTranscript) {
                        interimText.textContent = `인식 중: "${interimTranscript}"`;
                    }

                    if (finalTranscript) {
                        interimText.textContent = `인식됨: "${finalTranscript}"`;
                        console.log("[DEBUG] 인식된 최종 음성:", finalTranscript);
                        
                        const command = finalTranscript.trim();
                        const normalizedCommand = command.toLowerCase().replace(/\s/g, '');

                        if (!wakeWordDetected) {
                            const wakeWordNormalized = WAKE_WORD.toLowerCase().replace(/\s/g, '');
                            if (normalizedCommand.includes(wakeWordNormalized)) {
                                wakeWordDetected = true;
                                playSound();
                                speechStatus.textContent = `"${WAKE_WORD}" 감지! 이제 "위로 올려줘" 또는 "아래로 내려줘"라고 말해주세요.`;
                                speechStatusBar.classList.add('listening-for-command');
                                console.log("[DEBUG] 웨이크 워드 감지됨. wakeWordDetected: " + wakeWordDetected);
                                clearTimeout(commandTimeout);
                                commandTimeout = setTimeout(() => {
                                    speechStatus.textContent = "명령 대기 시간이 초과되었습니다. 다시 '하이 빅스비'라고 말해주세요.";
                                    resetWakeWordState();
                                }, COMMAND_TIMEOUT_MS);
                            }
                        } else {
                            clearTimeout(commandTimeout);
                            
                            const visibleHeight = videoFeed.clientHeight;
                            const scrollAmount = visibleHeight / 2;
                            let commandExecuted = false;

                            const isScrollUpCommand = SCROLL_UP_COMMANDS.some(cmd => 
                                normalizedCommand.includes(cmd.toLowerCase().replace(/\s/g, ''))
                            );
                            if (isScrollUpCommand) {
                                console.log(`[DEBUG] '위로 올려줘' 명령 실행.`);
                                videoFeed.scrollBy({ top: -scrollAmount, behavior: 'smooth' });
                                playSound();
                                speechStatus.textContent = '위로 반만 스크롤했습니다!';
                                speechStatusBar.classList.add('command-executed');
                                commandExecuted = true;
                            }

                            if (!commandExecuted) {
                                const isScrollDownCommand = SCROLL_DOWN_COMMANDS.some(cmd => 
                                    normalizedCommand.includes(cmd.toLowerCase().replace(/\s/g, ''))
                                );
                                if (isScrollDownCommand) {
                                    console.log(`[DEBUG] '아래로 내려줘' 명령 실행.`);
                                    videoFeed.scrollBy({ top: scrollAmount, behavior: 'smooth' });
                                    playSound();
                                    speechStatus.textContent = '아래로 반만 스크롤했습니다!';
                                    speechStatusBar.classList.add('command-executed');
                                    commandExecuted = true;
                                }
                            }
                            
                            if (commandExecuted) {
                                // 명령 실행 후 웨이크 워드 대기 상태로 돌아감
                                setTimeout(() => {
                                    resetWakeWordState();
                                }, 1500); // 1.5초 후 상태 리셋
                            } else {
                                console.log("[DEBUG] 알 수 없는 명령 (웨이크 워드 후). 명령:", command);
                                speechStatus.textContent = `알 수 없는 명령: "${command}". 다시 "위로 올려줘" 또는 "아래로 내려줘"라고 말해주세요.`;
                                speechStatusBar.classList.add('error-state');
                                setTimeout(() => {
                                    resetWakeWordState();
                                }, 2500);
                            }
                        }
                    }
                };

                recognition.onerror = (event) => {
                    isRecognitionActive = false;
                    micIcon.classList.remove('mic-pulsing');
                    micIcon.style.opacity = '0.6';
                    
                    if (event.error === 'not-allowed') {
                        console.error('[DEBUG] 음성 인식 오류: 마이크 접근이 거부되었습니다.');
                        const instructions = [
                            '1. 브라우저 주소창 왼쪽에 있는 **자물쇠** 또는 **마이크 아이콘**을 클릭합니다.',
                            '2. 권한 설정 메뉴에서 **마이크** 항목을 찾아 **"허용"**으로 변경합니다.',
                            '3. 이 페이지를 **새로고침**합니다.'
                        ];
                        showErrorModalWithList("마이크 접근이 거부되었습니다. 아래 단계를 따라 수동으로 권한을 허용해주세요.", instructions);
                        speechStatusBar.classList.add('error-state');
                    } else if (event.error === 'network') {
                         console.error('[DEBUG] 음성 인식 오류: 네트워크 오류가 발생했습니다.');
                         const errorMessage = `네트워크 오류가 발생했습니다. 인터넷 연결을 확인해주세요.`;
                         speechStatus.textContent = errorMessage;
                         showErrorModal(errorMessage);
                    } else if (event.error === 'no-speech') {
                         console.log("[DEBUG] (정상적인 동작) 음성 입력이 감지되지 않아 인식이 종료되었습니다. 1초 후 자동으로 재시작합니다.");
                    } else {
                        console.error('[DEBUG] 음성 인식 오류:', event.error);
                        const errorMessage = `음성 인식 오류가 발생했습니다: ${event.error}`;
                        speechStatus.textContent = errorMessage;
                        showErrorModal(errorMessage);
                    }
                };

                recognition.onend = () => {
                    console.log("[DEBUG] 음성 인식 종료됨.");
                    isRecognitionActive = false;
                    micIcon.classList.remove('mic-pulsing');
                    micIcon.style.opacity = '0.6';
                    // 1초 후 재시작 시도 (Too fast) 오류 방지
                    console.log("[DEBUG] 1초 후 음성 인식을 재시작합니다.");
                    setTimeout(() => {
                        startSpeechRecognition();
                    }, 1000);
                };
                
                recognition.start();
                console.log("[DEBUG] recognition.start() 호출됨.");
            }

            // 초기화 함수: 마이크 권한을 요청하고 스트림을 얻는 부분
            async function init() {
                speechStatus.textContent = '마이크 권한을 확인 중입니다...';
                try {
                    // 마이크 권한 요청 및 스트림 얻기
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log("[DEBUG] 마이크 권한 허용됨. 스트림 획득 성공.");
                    
                    // 권한이 허용되면 음성 인식을 시작합니다.
                    startSpeechRecognition();

                } catch (error) {
                    console.error("[DEBUG] 마이크 권한 요청 실패:", error);
                    speechStatusBar.classList.add('error-state');
                    
                    const instructions = [
                        '1. 브라우저 주소창 왼쪽에 있는 **자물쇠** 또는 **마이크 아이콘**을 클릭합니다.',
                        '2. 권한 설정 메뉴에서 **마이크** 항목을 찾아 **"허용"**으로 변경합니다.',
                        '3. 이 페이지를 **새로고침**합니다.'
                    ];
                    
                    if (error.name === 'NotAllowedError' || error.name === 'SecurityError') {
                        showErrorModalWithList("마이크 접근이 거부되었습니다. 아래 단계를 따라 수동으로 권한을 허용해주세요.", instructions);
                    } else if (error.name === 'NotFoundError') {
                        showErrorModal('마이크 장치를 찾을 수 없습니다. 장치가 올바르게 연결되어 있는지 확인해주세요.');
                    } else {
                        showErrorModal(`마이크 요청 오류가 발생했습니다: ${error.message}`);
                    }
                }
            }

            init();

            // 오류 팝업 닫기 버튼 이벤트
            closeErrorModalButton.addEventListener('click', hideErrorModal);
        });
    </script>
</body>
</html>
